{% extends 'base.html' %}
{% load static %}

{% block title %}Minhas Turmas{% endblock %}

{% block extra_head %}
<style>
    /* --- Estilos Específicos para a Página de Turmas --- */

    /* Cabeçalho da Página */
    .page-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        padding-bottom: 1rem;
        margin-bottom: 2rem !important;
        border-bottom: 2px solid;
        border-image-slice: 1;
        border-image-source: var(--accent-gradient);
    }
    .page-header h1 {
        font-family: var(--font-title);
        color: var(--text-light);
        font-size: 2.5rem;
        letter-spacing: 1px;
        margin: 0;
    }

    /* Alerta de Dicas */
    .alert.alert-info {
        background-color: rgba(0, 164, 217, 0.1);
        border: 1px solid var(--color-primary);
        color: var(--color-primary);
        font-weight: 500;
    }
    .alert.alert-info i {
        margin-right: 0.5rem;
    }

    /* Card Principal e Cabeçalho */
    .card-header h5 {
        font-family: var(--font-body);
        font-weight: 600;
        color: var(--text-light);
    }

    /* Tabela de Turmas - CORRIGIDO */
    .table {
        color: var(--text-light);
        border-color: var(--border-color);
    }
    .table thead th {
        color: var(--text-muted);
        background-color: var(--bg-surface);
        border-bottom: 2px solid var(--border-color);
        font-weight: 600;
    }
    .table tbody tr {
        border-bottom: 1px solid var(--border-color);
        background-color: var(--bg-dark); /* Fundo padrão escuro */
        cursor: move;
        transition: all 0.2s ease;
    }
    .table tbody tr td {
        background-color: var(--bg-dark) !important; /* Força o fundo escuro */
        color: var(--text-light) !important;
    }
    .table-striped>tbody>tr:nth-of-type(odd) {
        background-color: rgba(30, 32, 58, 0.3) !important;
    }
    .table-striped>tbody>tr:nth-of-type(odd)>* {
        background-color: rgba(30, 32, 58, 0.3) !important;
        color: var(--text-light) !important;
    }
    .table-striped>tbody>tr:nth-of-type(even) {
        background-color: var(--bg-dark) !important;
    }
    .table-striped>tbody>tr:nth-of-type(even)>* {
        background-color: var(--bg-dark) !important;
        color: var(--text-light) !important;
    }
    .table-hover>tbody>tr:hover {
        background-color: var(--bg-surface) !important;
    }
    .table-hover>tbody>tr:hover>* {
        background-color: var(--bg-surface) !important;
        color: var(--text-light) !important;
    }
    .table td, .table th {
        vertical-align: middle;
    }

    /* Estilos para Drag and Drop */
    .table tbody tr.dragging {
        opacity: 0.5;
        background-color: var(--color-primary) !important;
    }
    .table tbody tr.dragging * {
        background-color: var(--color-primary) !important;
    }
    .table tbody tr.drag-over {
        border-top: 3px solid var(--color-primary);
    }
    .drag-handle {
        cursor: grab;
        color: var(--text-muted);
        margin-right: 0.5rem;
    }
    .drag-handle:active {
        cursor: grabbing;
    }

    .btn-secondary:hover {
        background-color: var(--color-primary);
        border-color: var(--color-primary);
        color: var(--text-light);
        transform: translateY(-2px);
    }

    /* Badges na Tabela */
    .badge.bg-count {
        background-color: var(--color-secondary);
        color: var(--text-light);
    }
    .badge.bg-simulados {
        background-color: var(--color-success);
        color: var(--bg-dark);
    }

    /* Botões na Tabela */
    .btn-compact {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .btn-action-width {
        min-width: 185px; /* Ensures both buttons have same width */
    }
    .btn-success {
        background-color: var(--color-success);
        border-color: var(--color-success);
        color: var(--bg-dark);
    }
    .btn-success:hover {
        background-color: #28b88d;
        border-color: #28b88d;
        color: var(--bg-dark);
    }

    /* Botão de Adicionar Simulado */
    .btn-add-simulado {
        background: linear-gradient(135deg, #ffd93d 0%, #f6c744 100%);
        border: none;
        color: var(--bg-dark);
        font-weight: 600;
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
        border-radius: 0.375rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(255, 217, 61, 0.3);
    }
    .btn-add-simulado:hover {
        background: linear-gradient(135deg, #ffdf5d 0%, #ffd93d 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 217, 61, 0.4);
        color: var(--bg-dark);
    }
    .btn-add-simulado i {
        margin-right: 0.3rem;
    }

    /* Estado Vazio */
    .empty-state {
        padding: 3rem;
    }
    .empty-state i {
        color: var(--border-color);
    }
    .empty-state h5, .empty-state p {
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header">
        <h1>Minhas Turmas</h1>
        <div>
            <a href="{% url 'class_create' %}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> Nova Turma
            </a>
            <a href="{% url 'import_students' %}" class="btn btn-secondary">
                <i class="fas fa-file-import"></i> Importar Alunos
            </a>
        </div>
    </div>

    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle"></i> Clique no nome da turma para gerenciar seus alunos ou arraste as linhas para reordenar.
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Turmas Cadastradas</h5>
        </div>
        <div class="card-body p-0">
            {% if classes %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 30px;"></th>
                                <th>Nome</th>
                                <th>Descrição</th>
                                <th class="text-center">Alunos</th>
                                <th class="text-center">Simulados</th>
                                <th>Ações</th>
                                <th>Desempenho</th>
                            </tr>
                        </thead>
                        <tbody id="turmasTableBody">
                            {% for class in classes %}
                            <tr draggable="true" data-id="{{ class.pk }}">
                                <td>
                                    <i class="fas fa-grip-vertical drag-handle"></i>
                                </td>
                                <td>
                                    <a href="{% url 'class_students' class.pk %}" class="fw-bold">
                                        {{ class.name }}
                                    </a>
                                </td>
                                <td>{{ class.description|truncatewords:8|default:"--" }}</td>
                                <td class="text-center">
                                    <span class="badge bg-count">{{ class.students.count }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-simulados">{{ class.simulados.count }}</span>
                                </td>
                                <td>
                                    <div class="d-flex gap-1">
                                        <a href="{% url 'class_students' class.pk %}" class="btn btn-secondary btn-compact" title="Gerenciar Alunos">Alunos</a>
                                        <a href="{% url 'class_edit' class.pk %}" class="btn btn-secondary btn-compact" title="Editar Turma">Editar</a>
                                        <a href="{% url 'class_delete' class.pk %}" class="btn btn-danger btn-compact" title="Excluir Turma">Excluir</a>
                                    </div>
                                </td>
                                <td>
                                    {% if class.simulados.count > 0 %}
                                    <a href="{% url 'class_select_simulado' class.pk %}" class="btn btn-success btn-compact btn-action-width">
                                        <i class="fas fa-chart-bar"></i> Ver Desempenho
                                    </a>
                                    {% else %}
                                    <a href="{% url 'questions:simulado_list' %}" class="btn btn-warning btn-compact btn-action-width">
                                        <i class="fas fa-plus"></i> Cadastrar Simulado
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center empty-state">
                    <div class="mb-3">
                        <i class="fas fa-school fa-3x"></i>
                    </div>
                    <h5>Nenhuma turma cadastrada</h5>
                    <p>Clique no botão "Nova Turma" para começar.</p>
                    <a href="{% url 'class_create' %}" class="btn btn-primary mt-2">
                        <i class="fas fa-plus-circle"></i> Criar minha primeira turma
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.getElementById('turmasTableBody');
    if (!tbody) return;

    let draggedElement = null;

    tbody.querySelectorAll('tr').forEach(row => {
        row.addEventListener('dragstart', e => {
            draggedElement = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        });

        row.addEventListener('dragend', e => {
            e.target.classList.remove('dragging');
            draggedElement = null;
            saveOrderToServer();
        });

        row.addEventListener('dragover', e => {
            e.preventDefault();
            const target = e.target.closest('tr');
            if (target && target !== draggedElement) {
                const rect = target.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                if (e.clientY < midpoint) {
                    tbody.insertBefore(draggedElement, target);
                } else {
                    tbody.insertBefore(draggedElement, target.nextSibling);
                }
            }
        });
    });

    function saveOrderToServer() {
        const order = Array.from(tbody.querySelectorAll('tr')).map(row => row.dataset.id);

        fetch("{% url 'update_class_order' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ order: order })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                console.error('Erro ao salvar a ordem:', data.message);
                // Opcional: Adicionar um alerta para o usuário
                // alert('Não foi possível salvar a nova ordem das turmas.');
            }
        })
        .catch(error => {
            console.error('Erro de rede ao salvar a ordem:', error);
            // alert('Ocorreu um erro de rede. Tente novamente.');
        });
    }
});
</script>
{% endblock %}
{% extends 'base.html' %}

{% block title %}Desempenho da Turma {{ class.name }} - {{ simulado.titulo }}{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Desempenho da Turma {{ class.name }}</h1>
    <div>
        <a href="{% url 'exportar_dashboard_pdf' class_id=class.id simulado_id=simulado.id %}"
        class="btn btn-success">
            <i class="fas fa-file-pdf"></i> Gerar Relatório PDF
        </a>

        <a href="{% url 'class_list' %}" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> Voltar para Turmas
        </a>
        <a href="{% url 'class_students' class.id %}" class="btn btn-primary">
            <i class="fas fa-users"></i> Ver Alunos
        </a>
        <!-- Adicionar botão de excluir dados -->
        <a href="{% url 'class_simulado_limpar' class.id simulado.id %}" class="btn btn-danger">
            <i class="fas fa-trash"></i> Excluir Dados
        </a>
    </div>
</div>

    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-center">
            <div class="me-3">
                <i class="fas fa-info-circle fa-2x"></i>
            </div>
            <div>
                <h5 class="alert-heading mb-1">Simulado: {{ simulado.titulo }}</h5>
                <p class="mb-0">Esta página mostra o desempenho geral da turma no simulado, além de estatísticas detalhadas por disciplina e assunto.</p>
            </div>
        </div>
    </div>

    <!-- Estatísticas gerais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h1 class="display-4">{{ total_participantes }}</h1>
                    <p class="mb-0">Alunos Participantes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h1 class="display-4">{{ media_turma|floatformat:1 }}</h1>
                    <p class="mb-0">Média da Turma</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h1 class="display-4">{{ total_alunos }}</h1>
                    <p class="mb-0">Total de Alunos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h1 class="display-4">{{ estatisticas_disciplinas|length }}</h1>
                    <p class="mb-0">Disciplinas Avaliadas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Notas por Aluno</h5>
                </div>
                <div class="card-body">
                    <div id="notasChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Desempenho por Disciplina</h5>
                </div>
                <div class="card-body">
                    <canvas id="disciplinasChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Distribuição de Notas</h5>
                </div>
                <div class="card-body">
                    <canvas id="distribuicaoChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas por disciplina -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Desempenho por Disciplina</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Disciplina</th>
                            <th>Acertos</th>
                            <th>Total</th>
                            <th>Percentual</th>
                            <th>Desempenho</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for disciplina in estatisticas_disciplinas %}
                        <tr>
                            <td>{{ disciplina.nome }}</td>
                            <td>{{ disciplina.acertos }}</td>
                            <td>{{ disciplina.total }}</td>
                            <td>{{ disciplina.percentual|floatformat:1 }}%</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success disciplina-progress-bar"
                                        data-percent="{{ disciplina.percentual }}"
                                        aria-valuenow="{{ disciplina.percentual }}"
                                        aria-valuemin="0"
                                        aria-valuemax="100">
                                        {{ disciplina.percentual|floatformat:1 }}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">Nenhuma disciplina encontrada</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Estatísticas por assunto -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Desempenho por Assunto</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Assunto</th>
                            <th>Acertos</th>
                            <th>Total</th>
                            <th>Percentual</th>
                            <th>Desempenho</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for assunto in estatisticas_assuntos %}
                        <tr>
                            <td>{{ assunto.nome }}</td>
                            <td>{{ assunto.acertos }}</td>
                            <td>{{ assunto.total }}</td>
                            <td>{{ assunto.percentual|floatformat:1 }}%</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success assunto-progress-bar"
                                        data-percent="{{ assunto.percentual }}"
                                        aria-valuenow="{{ assunto.percentual }}"
                                        aria-valuemin="0"
                                        aria-valuemax="100">
                                        {{ assunto.percentual|floatformat:1 }}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">Nenhum assunto encontrado</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ALUNOS SEM CORREÇÃO -->
    <!-- ============================================ -->
    {% if alunos_sem_notas %}
    <div class="card mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
            <h5 class="mb-0">
                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                Alunos Aguardando Correção
                <span class="badge bg-warning text-dark ms-2">{{ total_sem_notas }}</span>
            </h5>
            <button class="btn btn-sm btn-outline-light" type="button"
                    data-bs-toggle="collapse" data-bs-target="#alunosSemNotas"
                    aria-expanded="true">
                <i class="fas fa-chevron-down" id="iconToggleSemNotas"></i>
            </button>
        </div>
        <div class="collapse show" id="alunosSemNotas">
            <div class="alert alert-info m-3 mb-0 d-flex align-items-center">
                <i class="fas fa-info-circle me-2 fs-5"></i>
                <div>
                    <strong>Informação:</strong> Os alunos listados abaixo ainda não tiveram seus simulados corrigidos.
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="alunosSemNotasTable">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 60px;" class="text-center">#</th>
                                <th>Nome do Aluno</th>
                                <th style="width: 150px;" class="text-center">Status</th>
                                <th style="width: 120px;" class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for aluno in alunos_sem_notas %}
                            <tr>
                                <td class="text-center text-muted fw-bold">
                                    {{ forloop.counter }}
                                </td>
                                <td>
                                    <i class="fas fa-user-clock text-muted me-2"></i>
                                    <strong>{{ aluno.name }}</strong>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary px-3 py-2">
                                        <i class="fas fa-hourglass-half"></i> Pendente
                                    </span>
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'student_dashboard' aluno.id %}"
                                       class="btn btn-sm btn-outline-primary"
                                       title="Ver perfil do aluno"
                                       data-bs-toggle="tooltip">
                                        <i class="fas fa-user"></i> Ver
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Todos os alunos já foram corrigidos!
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}


    <!-- Resultados individuais -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-trophy text-warning"></i>
                Ranking de Desempenho
                <span class="badge bg-success ms-2">{{ total_participantes }} corrigido(s)</span>
            </h5>
            <div class="input-group" style="max-width: 300px;">
                <input type="text" id="searchAluno" class="form-control text-white" placeholder="Buscar aluno..." style="background-color: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.3);">
                <button class="btn btn-outline-light" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="alunosTable">
                    <thead>
                        <tr>
                            <th>Aluno</th>
                            <th>Nota</th>
                            <th>Acertos</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for resultado in resultados %}
                        <tr>
                            <td>{{ resultado.aluno.name }}</td>
                            <td>{{ resultado.nota|floatformat:2 }}</td>
                            <td>{{ resultado.acertos }}/{{ resultado.total }}</td>
                            <td>
                                <a href="{% url 'student_dashboard' resultado.aluno.id %}" class="btn btn-primary btn-sm me-1">
                                    Painel do Aluno
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center">Nenhum resultado encontrado</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% block extra_head %}
<style>
    /* Tabela de Turmas - CORRIGIDO */
    .table {
        color: var(--text-light);
        border-color: var(--border-color);
    }
    .table thead th {
        color: var(--text-muted);
        background-color: var(--bg-surface);
        border-bottom: 2px solid var(--border-color);
        font-weight: 600;
    }
    .table tbody tr {
        border-bottom: 1px solid var(--border-color);
        background-color: var(--bg-dark); /* Fundo padrão escuro */
    }
    .table tbody tr td {
        background-color: var(--bg-dark) !important; /* Força o fundo escuro */
        color: var(--text-light) !important;
    }
    .table-striped>tbody>tr:nth-of-type(odd) {
        background-color: rgba(30, 32, 58, 0.3) !important;
    }
    .table-striped>tbody>tr:nth-of-type(odd)>* {
        background-color: rgba(30, 32, 58, 0.3) !important;
        color: var(--text-light) !important;
    }
    .table-striped>tbody>tr:nth-of-type(even) {
        background-color: var(--bg-dark) !important;
    }
    .table-striped>tbody>tr:nth-of-type(even)>* {
        background-color: var(--bg-dark) !important;
        color: var(--text-light) !important;
    }
    .table-hover>tbody>tr:hover {
        background-color: var(--bg-surface) !important;
    }
    .table-hover>tbody>tr:hover>* {
        background-color: var(--bg-surface) !important;
        color: var(--text-light) !important;
    }
    .table td, .table th {
        vertical-align: middle;
    }
    /* Corrigir barras de progresso */
    .progress {
        background-color: rgba(255, 255, 255, 0.1);
        height: 20px;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #28a745 !important;
        color: white;
        font-weight: bold;
        font-size: 12px;
        transition: width 0.6s ease;
        white-space: nowrap;
    }

    /* Estilos adicionais para Plotly no tema escuro */
    .js-plotly-plot .plotly,
    .js-plotly-plot .main-svg,
    .js-plotly-plot .svg-container {
        background-color: transparent !important;
    }

    .js-plotly-plot .grid-layer path {
        stroke: rgba(255, 255, 255, 0.1) !important;
    }

    .js-plotly-plot .xaxis .xtick text,
    .js-plotly-plot .yaxis .ytick text,
    .js-plotly-plot .xaxis .xtitle text,
    .js-plotly-plot .yaxis .ytitle text,
    .js-plotly-plot .legend text {
        fill: var(--text-light) !important;
    }
    .card-header h5 {
        color: var(--text-light) !important;
    }

    /* Placeholder branco para o campo de busca */
    #searchAluno::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    #searchAluno:focus {
        background-color: rgba(255, 255, 255, 0.15) !important;
        border-color: rgba(255, 255, 255, 0.5) !important;
    }


    /* Card de alunos sem notas */
    .border-warning {
        border-left: 4px solid #ffc107 !important;
    }

    /* Efeito hover na tabela de alunos sem notas */
    #alunosSemNotasTable tbody tr:hover {
        background-color: rgba(255, 193, 7, 0.1) !important;
        transform: translateX(2px);
        transition: all 0.2s ease;
    }

    /* Shadow nos cards */
    .shadow-sm {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
    }
</style>
{% endblock %}

<!-- Scripts para gráficos -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Dados para gráficos -->
<div id="chart-data"
    data-nomes='{{ nomes_alunos_json }}'
    data-notas='{{ notas_alunos_json }}'
    data-disciplinas='{{ disciplinas_nomes_json }}'
    data-percentuais='{{ disciplinas_percentuais_json }}'
    style="display:none;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM carregado, iniciando script");

    // Configurar as barras de progresso via JavaScript
    document.querySelectorAll('.disciplina-progress-bar, .assunto-progress-bar').forEach(function(bar) {
        const percent = parseFloat(bar.getAttribute('data-percent'));
        if (!isNaN(percent)) {
            bar.style.width = percent + '%';
            // Garantir que o texto seja visível
            if (percent < 10) {
                bar.style.paddingLeft = '5px';
                bar.style.justifyContent = 'flex-start';
            }
        }
    });

    // Obter dados para os gráficos
    const chartData = document.getElementById('chart-data');
    console.log("Elemento chartData:", chartData);

    if (!chartData) {
        console.error("Elemento chart-data não encontrado!");
        return;
    }

    // Log dos atributos brutos para depuração
    console.log("Atributos brutos:", {
        nomes: chartData.getAttribute('data-nomes'),
        notas: chartData.getAttribute('data-notas'),
        disciplinas: chartData.getAttribute('data-disciplinas'),
        percentuais: chartData.getAttribute('data-percentuais')
    });

    // Usar dados fallback em caso de erro
    let nomesAlunos, notasAlunos, disciplinasNomes, disciplinasPercentuais;

    try {
        nomesAlunos = JSON.parse(chartData.getAttribute('data-nomes') || '[]');
        notasAlunos = JSON.parse(chartData.getAttribute('data-notas') || '[]');
        disciplinasNomes = JSON.parse(chartData.getAttribute('data-disciplinas') || '[]');
        disciplinasPercentuais = JSON.parse(chartData.getAttribute('data-percentuais') || '[]');

        console.log("Parsing de JSON bem-sucedido");
    } catch (e) {
        console.error("Erro ao analisar JSON:", e);

        // Dados de fallback para teste
        nomesAlunos = ["Aluno 1", "Aluno 2", "Aluno 3", "Aluno 4", "Aluno 5"];
        notasAlunos = [8.5, 7.0, 6.2, 9.1, 5.4];
        disciplinasNomes = ["Matemática", "Português", "Ciências"];
        disciplinasPercentuais = [75, 60, 82];

        console.log("Usando dados de fallback para teste");
    }

    // Verificar dados recebidos
    console.log("Dados processados:", {
        nomes: nomesAlunos,
        notas: notasAlunos,
        disciplinas: disciplinasNomes,
        percentuais: disciplinasPercentuais
    });

    // Se não há dados, mostrar mensagem de erro
    if (nomesAlunos.length === 0 || notasAlunos.length === 0) {
        document.getElementById('notasChart').innerHTML =
            '<div class="alert alert-warning">Não há dados suficientes para exibir o gráfico.</div>';
        console.warn("Sem dados para exibir gráfico");
        return;
    }

    // Ordenar alunos por notas (decrescente)
    const alunosOrdenados = nomesAlunos.map((nome, index) => ({
        nome: nome,
        nota: notasAlunos[index]
    })).sort((a, b) => b.nota - a.nota);

    const nomesOrdenados = alunosOrdenados.map(a => a.nome);
    const notasOrdenadas = alunosOrdenados.map(a => a.nota);

    // Achar a nota máxima para ajustar o eixo Y
    const maxNota = Math.max(...notasOrdenadas);

    // Calcular estatísticas
    const media = notasAlunos.reduce((a, b) => a + b, 0) / notasAlunos.length || 0;

    // Calcular desvio padrão
    const desvio = Math.sqrt(
        notasAlunos.map(x => Math.pow(x - media, 2)).reduce((a, b) => a + b, 0) / notasAlunos.length || 0
    );

    // Classificar alunos
    const classificacoes = notasOrdenadas.map(nota => {
        if (nota >= media + desvio) return 'Muito Acima da Média';
        else if (nota >= media + 0.5 * desvio) return 'Acima da Média';
        else if (nota >= media - 0.5 * desvio) return 'Na Média';
        else if (nota >= media - desvio) return 'Abaixo da Média';
        else return 'Muito Abaixo da Média';
    });

    // Cores para cada classificação
    const coresMapa = {
        'Muito Acima da Média': 'green',
        'Acima da Média': 'lime',
        'Na Média': 'gold',
        'Abaixo da Média': 'lightblue',
        'Muito Abaixo da Média': 'red'
    };

    const cores = classificacoes.map(c => coresMapa[c]);

    // Abordagem simplificada para testar
    const tracesSimples = [{
        x: nomesOrdenados,
        y: notasOrdenadas,
        type: 'scatter',
        mode: 'lines+markers+text',
        marker: {
            color: cores,
            size: 12,
            line: {
                color: 'white',
                width: 1
            }
        },
        line: {
            color: 'rgba(173, 216, 230, 0.7)',
            width: 2
        },
        text: notasOrdenadas.map(n => n.toFixed(1)),
        textposition: 'top center',
        textfont: {
            family: 'Arial, sans-serif',
            size: 12,
            color: 'white',
            weight: 'bold'
        },
        hoverinfo: 'text',
        hovertext: nomesOrdenados.map((nome, i) =>
            `<b>${nome}</b><br>Nota: <b>${notasOrdenadas[i].toFixed(1)}</b><br>${classificacoes[i]}`
        ),
        hoverlabel: {
            bgcolor: '#333',
            bordercolor: '#999',
            font: {
                family: 'Arial',
                size: 14,
                color: 'white'
            }
        }
    }];

    const layoutSimples = {
        title: {
            text: 'Notas por Aluno',
            font: {
                color: 'white',
                size: 18,
                weight: 'bold'
            },
            x: 0.5,
            y: 0.95
        },
        xaxis: {
            title: {
                text: 'Aluno',
                font: {
                    color: 'white',
                    size: 14,
                    weight: 'bold'
                },
                standoff: 20
            },
            tickangle: -45,
            color: 'white',
            type: 'category',
            tickfont: {
                size: 11,
                color: 'rgba(255, 255, 255, 0.9)'
            },
            gridcolor: 'rgba(255, 255, 255, 0.1)'
        },
        yaxis: {
            title: {
                text: 'Nota',
                font: {
                    color: 'white',
                    size: 14,
                    weight: 'bold'
                },
                standoff: 20
            },
            range: [0, maxNota + 1],
            color: 'white',
            tickfont: {
                size: 12,
                color: 'rgba(255, 255, 255, 0.9)'
            },
            gridcolor: 'rgba(255, 255, 255, 0.1)',
            zerolinecolor: 'rgba(255, 255, 255, 0.3)'
        },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {color: 'white'},
        margin: {
            l: 60,
            r: 50,
            b: 180,
            t: 60,
            pad: 4
        },
        hovermode: 'closest',
        showlegend: false
    };

    // Adicionar linha da média
    layoutSimples.shapes = [{
        type: 'line',
        x0: -0.5,
        x1: nomesOrdenados.length - 0.5,
        y0: media,
        y1: media,
        line: {
            color: 'rgba(255, 100, 100, 0.8)',
            width: 2,
            dash: 'dash'
        }
    }];

    // Configuração personalizada para o gráfico
    const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false,
        modeBarButtonsToRemove: ['select2d', 'lasso2d', 'autoScale2d'],
        toImageButtonOptions: {
            format: 'png',
            filename: 'notas_por_aluno',
            height: 500,
            width: 900,
            scale: 2
        }
    };

    Plotly.newPlot('notasChart', tracesSimples, layoutSimples, config)
        .then(() => {
            console.log("Gráfico simples carregado com sucesso");
            renderizarGraficoCompleto();
        })
        .catch(err => {
            console.error("Erro ao renderizar gráfico simples:", err);
            document.getElementById('notasChart').innerHTML =
                `<div class="alert alert-danger">
                    Erro ao carregar o gráfico: ${err.message}
                </div>`;
        });

    function renderizarGraficoCompleto() {
        try {
            // Agrupar dados por classificação
            const categorias = [...new Set(classificacoes)];
            const traces = [];

            // Adicionar linha conectando todos os pontos
            traces.push({
                x: nomesOrdenados,
                y: notasOrdenadas,
                mode: 'lines',
                line: {
                    color: 'rgba(173, 216, 230, 0.7)',
                    width: 2
                },
                name: 'Notas',
                showlegend: false
            });

            // Adicionar pontos por categoria
            categorias.forEach(categoria => {
                const indices = classificacoes.map((c, i) => c === categoria ? i : -1).filter(i => i !== -1);
                const nomes = indices.map(i => nomesOrdenados[i]);
                const notas = indices.map(i => notasOrdenadas[i]);

                // Trace para visualização com texto e marcadores
                traces.push({
                    x: nomes,
                    y: notas,
                    mode: 'markers+text',
                    text: notas.map(n => n.toFixed(1)),
                    textposition: 'top center',
                    textfont: {
                        family: 'Arial, sans-serif',
                        size: 12,
                        color: 'white',
                        weight: 'bold'
                    },
                    marker: {
                        color: coresMapa[categoria],
                        size: 12,
                        line: {
                            color: 'white',
                            width: 1
                        }
                    },
                    name: categoria,
                    showlegend: false,
                    legendgroup: categoria,
                    hoverinfo: 'text',
                    hovertext: nomes.map((nome, i) =>
                        `<b>${nome}</b><br>Nota: <b>${notas[i].toFixed(1)}</b><br>${categoria}`
                    ),
                    hoverlabel: {
                        bgcolor: '#333',
                        bordercolor: '#999',
                        font: {
                            family: 'Arial',
                            size: 14,
                            color: 'white'
                        }
                    }
                });

                // Trace apenas para a legenda - sem texto, só marcador
                traces.push({
                    x: [null],
                    y: [null],
                    mode: 'markers',
                    marker: {
                        color: coresMapa[categoria],
                        size: 12,
                        line: {
                            color: 'white',
                            width: 1
                        }
                    },
                    legendgroup: categoria,
                    name: categoria,
                    showlegend: true,
                    hoverinfo: 'none' // Desabilitar hover nos pontos da legenda
                });
            });

            // Modificar o layout para tema escuro
            const layout = {
                title: {
                    text: 'Notas por Aluno',
                    font: {
                        color: 'white',
                        size: 18,
                        weight: 'bold'
                    },
                    x: 0.5,
                    y: 0.95
                },
                xaxis: {
                    title: {
                        text: 'Aluno',
                        font: {
                            color: 'white',
                            size: 14,
                            weight: 'bold'
                        },
                        standoff: 20
                    },
                    tickangle: -45,
                    color: 'white',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    type: 'category',
                    tickfont: {
                        size: 11,
                        color: 'rgba(255, 255, 255, 0.9)'
                    }
                },
                yaxis: {
                    title: {
                        text: 'Nota',
                        font: {
                            color: 'white',
                            size: 14,
                            weight: 'bold'
                        },
                        standoff: 20
                    },
                    range: [0, maxNota + 1],
                    color: 'white',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: {
                        size: 12,
                        color: 'rgba(255, 255, 255, 0.9)'
                    },
                    zerolinecolor: 'rgba(255, 255, 255, 0.3)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                legend: {
                    title: {
                        text: 'Classificação',
                        font: {
                            color: 'white',
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    font: {
                        color: 'white',
                        size: 12
                    },
                    bgcolor: 'rgba(50, 50, 50, 0.7)',
                    bordercolor: 'rgba(255, 255, 255, 0.3)',
                    borderwidth: 1,
                    x: 0.5,           // Centralizada horizontalmente
                    y: -0.80,          // Posicionada abaixo do gráfico
                    xanchor: 'center', // Ancorada no centro
                    yanchor: 'top',
                    orientation: 'h',  // Horizontal (era 'v')
                    itemsizing: 'constant',
                    itemwidth: 60,
                    tracegroupgap: 10
                },
                shapes: [
                    // Linha horizontal da média - MODIFICADA PARA SER MAIS DISCRETA
                    {
                        type: 'line',
                        x0: -0.5,
                        x1: nomesOrdenados.length - 0.5,
                        y0: media,
                        y1: media,
                        line: {
                            color: 'rgba(255, 80, 80, 0.5)', // Mais transparente
                            width: 2.5,
                            dash: 'dash'
                        }
                    }
                ],

                margin: {
                    l: 60,
                    r: 50,
                    b: 180,
                    t: 60,
                    pad: 4
                },
                hovermode: 'closest'
            };

            // Adicionar linhas verticais tracejadas
            nomesOrdenados.forEach((nome, i) => {
                layout.shapes.push({
                    type: 'line',
                    x0: i,
                    x1: i,
                    y0: 0,
                    y1: notasOrdenadas[i],
                    line: {
                        color: 'rgba(180, 180, 180, 0.3)',
                        width: 1,
                        dash: 'dot'
                    }
                });
            });

            console.log("Dados do gráfico completo:", {
                traces: traces,
                layout: layout,
                dataLen: notasAlunos.length
            });

            // Configuração personalizada para o gráfico
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['select2d', 'lasso2d', 'autoScale2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'notas_por_aluno_detalhado',
                    height: 500,
                    width: 900,
                    scale: 2
                }
            };

            Plotly.newPlot('notasChart', traces, layout, config)
                .then(() => console.log("Gráfico completo carregado com sucesso"))
                .catch(err => console.error("Erro ao renderizar gráfico completo:", err));
        } catch (e) {
            console.error("Erro ao criar o gráfico completo:", e);
        }
    }

            // Verificar se Chart.js está disponível
            if (typeof Chart === 'undefined') {
                console.error("Chart.js não está carregado");
                return;
            }

            // Gráfico de barras para disciplinas
            if (disciplinasNomes.length > 0) {
                const ctxDisciplinas = document.getElementById('disciplinasChart').getContext('2d');
                if (ctxDisciplinas) {
                    new Chart(ctxDisciplinas, {
                        type: 'bar',
                        data: {
                            labels: disciplinasNomes,
                            datasets: [{
                                label: 'Percentual de Acertos',
                                data: disciplinasPercentuais,
                                backgroundColor: disciplinasPercentuais.map(perc => {
                                    if (perc >= 70) return 'rgba(40, 167, 69, 0.7)';
                                    else if (perc >= 50) return 'rgba(23, 162, 184, 0.7)';
                                    else if (perc >= 30) return 'rgba(255, 193, 7, 0.7)';
                                    else return 'rgba(220, 53, 69, 0.7)';
                                }),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: '#fff',
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: '#fff'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.raw}% de acertos`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.error("Elemento Canvas para disciplinas não encontrado");
                }
            } else {
                document.getElementById('disciplinasChart').parentNode.innerHTML =
                    '<div class="alert alert-warning">Não há dados de disciplinas para exibir.</div>';
            }

            // Contar frequência de notas
            const faixas = ['0-1', '1-2', '2-3', '3-4', '4-5', '5-6', '6-7', '7-8', '8-9', '9-10'];
            const contagem = Array(10).fill(0);

            notasAlunos.forEach(nota => {
                const indice = Math.min(Math.floor(nota), 9);
                contagem[indice]++;
            });

            // Gráfico de distribuição de notas
            const ctxDistribuicao = document.getElementById('distribuicaoChart').getContext('2d');
            if (ctxDistribuicao) {
                new Chart(ctxDistribuicao, {
                    type: 'bar',
                    data: {
                        labels: faixas,
                        datasets: [{
                            label: 'Alunos',
                            data: contagem,
                            backgroundColor: [
                                'rgba(220, 53, 69, 0.7)',
                                'rgba(220, 53, 69, 0.7)',
                                'rgba(220, 53, 69, 0.7)',
                                'rgba(108, 117, 125, 0.7)',
                                'rgba(255, 193, 7, 0.7)',
                                'rgba(255, 193, 7, 0.7)',
                                'rgba(23, 162, 184, 0.7)',
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(40, 167, 69, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#fff',
                                    precision: 0
                                },
                                title: {
                                    display: true,
                                    text: 'Quantidade de Alunos',
                                    color: '#fff'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#fff'
                                },
                                title: {
                                    display: true,
                                    text: 'Faixas de Notas',
                                    color: '#fff'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.raw} aluno(s)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                console.error("Elemento Canvas para distribuição não encontrado");
            }

            // Script para filtrar alunos na tabela
            const searchInput = document.getElementById('searchAluno');
            if (searchInput) {
                searchInput.addEventListener('keyup', function() {
                    const searchText = this.value.toLowerCase();
                    const table = document.getElementById('alunosTable');
                    const rows = table.getElementsByTagName('tr');

                    for (let i = 1; i < rows.length; i++) {
                        const nameCell = rows[i].getElementsByTagName('td')[0];
                        if (nameCell) {
                            const name = nameCell.textContent || nameCell.innerText;
                            if (name.toLowerCase().indexOf(searchText) > -1) {
                                rows[i].style.display = '';
                            } else {
                                rows[i].style.display = 'none';
                            }
                        }
                    }
                });
            }

            // Certificar que o gráfico se ajusta corretamente
            window.addEventListener('resize', function() {
                if (typeof Plotly !== 'undefined') {
                    Plotly.Plots.resize('notasChart');
                }
            });

            // Redimensionar após toda a página carregar
            window.addEventListener('load', function() {
                setTimeout(function() {
                    if (typeof Plotly !== 'undefined') {
                        Plotly.Plots.resize('notasChart');
                    }
                }, 500);
            });

    // Toggle do ícone do collapse de alunos sem notas
    const collapseSemNotas = document.getElementById('alunosSemNotas');
    if (collapseSemNotas) {
        collapseSemNotas.addEventListener('show.bs.collapse', function () {
            document.getElementById('iconToggleSemNotas')?.classList.replace('fa-chevron-down', 'fa-chevron-up');
        });

        collapseSemNotas.addEventListener('hide.bs.collapse', function () {
            document.getElementById('iconToggleSemNotas')?.classList.replace('fa-chevron-up', 'fa-chevron-down');
        });
    }

    // Ativar tooltips do Bootstrap 5
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
        });
        </script>
        {% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}Meus Créditos - SimuladoApp{% endblock %}

{% block extra_head %}
<style>
    /* --- Estilos Específicos para a Página de Créditos --- */

    /* Card do Cabeçalho da Página */
    .page-header-card h4 {
        font-family: var(--font-body);
        font-weight: 600;
        color: var(--text-light);
        font-size: 1.5rem;
    }
    .page-header-card .text-muted {
        color: var(--text-muted) !important;
    }
    .page-header-card .btn-outline-primary {
        color: var(--color-primary);
        border-color: var(--color-primary);
    }
    .page-header-card .btn-outline-primary:hover {
        background-color: var(--color-primary);
        color: var(--text-light);
    }

    /* Card de Saldo */
    .balance-card {
        background: var(--accent-gradient) !important;
    }
    .balance-card h2 {
        font-family: var(--font-title);
        font-size: 3.5rem;
        letter-spacing: 2px;
        color: var(--text-light);
    }

    /* Card de Estatísticas */
    .stats-card .card-header h5 {
        font-family: var(--font-title);
        color: var(--color-primary);
    }
    .stats-card h4 {
        font-family: var(--font-body);
        font-weight: 600;
        font-size: 2rem;
    }
    .stats-card .text-success { color: var(--color-success) !important; }
    .stats-card .text-info { color: var(--color-primary) !important; }
    .stats-card .text-warning { color: var(--color-warning) !important; }
    .stats-card .text-muted {
        color: var(--text-muted) !important;
    }
    .stats-card .progress-labels small {
        color: var(--text-light) !important;
    }
    .progress-bar {
        background-color: var(--color-primary);
    }

    /* Card "Como Funciona" */
    .how-it-works-card .card-header h5 {
        font-family: var(--font-title);
        color: var(--text-light);
    }
    .how-it-works-card .card-body strong {
        color: var(--color-primary);
    }
    .how-it-works-card .card-body .text-muted {
        color: var(--text-light) !important;
    }
    .how-it-works-card .guarantee-box {
        background-color: var(--bg-surface) !important;
        border-left: 4px solid var(--color-warning) !important;
    }
    .how-it-works-card .guarantee-box small,
    .how-it-works-card .guarantee-box strong {
        color: var(--text-muted) !important;
    }
    .how-it-works-card .guarantee-box i {
        color: var(--color-success) !important;
    }

    /* Cards de Planos de Crédito */
    .plans-card .card-header h5 {
        font-family: var(--font-title);
        color: var(--color-primary);
    }
    .plans-card .card-header .text-plan-description {
        color: var(--text-light) !important;
    }
    .plans-card .card-body {
        padding-top: 2rem;
    }
    .pricing-card .card-header {
        background-color: var(--bg-surface) !important;
        padding-top: 1.5rem;
        padding-bottom: 1rem;
    }
    .pricing-card .card-header h5 {
        font-family: var(--font-body);
        font-weight: 600;
        color: var(--color-primary) !important;
    }
    .pricing-card .card-header small {
        color: var(--text-muted) !important;
    }
    .pricing-card .display-4 {
        font-family: var(--font-title);
    }
    .pricing-card .price {
        color: var(--color-success);
    }
    .pricing-card .alert-info {
        background-color: rgba(0, 164, 217, 0.1);
        border-color: var(--color-primary);
        color: var(--text-light);
    }
    .pricing-card .badge {
        background-color: transparent;
        color: var(--color-primary);
        border: 1px solid var(--color-primary);
        font-weight: 600;
    }
    .pricing-card .card-body .text-muted.mb-2 {
        color: var(--text-muted) !important;
    }
    .plan-essencial .popular-badge {
        background: var(--color-success);
        color: var(--text-light);
        font-weight: 600;
        border: none;
    }
    .plan-essencial .card-header {
        padding-top: 2.5rem;
    }


    /* Acordeon do FAQ */
    .faq-card .card-header h5 {
        font-family: var(--font-title);
        color: var(--text-light) !important; /* COR ALTERADA AQUI */
    }
    .accordion-item {
        background-color: var(--bg-surface);
        border: 1px solid var(--border-color);
    }
    .accordion-button {
        background-color: var(--bg-surface);
        color: var(--text-light);
        font-weight: 600;
    }
    .accordion-button:not(.collapsed) {
        background-color: var(--bg-dark);
        color: var(--color-primary);
    }
    .accordion-button:focus {
        box-shadow: 0 0 0 0.25rem rgba(0, 164, 217, 0.25);
    }
    .accordion-button::after {
        filter: brightness(0) invert(1);
    }
    .accordion-body {
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card page-header-card">
            <div class="card-header d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="bi bi-credit-card me-3 fs-4" style="color: var(--color-primary);"></i>
                    <div>
                        <h4 class="mb-0">Sistema de Créditos</h4>
                        <small class="text-muted">Gerencie seus créditos para correção de simulados</small>
                    </div>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="carregarSaldo()" id="btn-refresh">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card balance-card text-white h-100">
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <i class="bi bi-wallet2 fs-1 mb-3"></i>
                <h2 id="saldo-creditos" class="mb-2">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </h2>
                <p class="mb-0 fw-bold">Créditos Disponíveis</p>
                <small class="opacity-75"><i class="bi bi-infinity"></i> Nunca expiram</small>
            </div>
        </div>
    </div>

    <div class="col-md-8 mb-4">
        <div class="card stats-card h-100">
            <div class="card-header">
                <h5><i class="bi bi-graph-up me-2"></i>Estatísticas de Uso</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <i class="bi bi-check-circle text-success fs-2"></i>
                            <h4 id="total-creditos" class="text-success mb-0">-</h4>
                            <small class="text-muted">Total Adquirido</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <i class="bi bi-arrow-down-circle text-info fs-2"></i>
                            <h4 id="creditos-usados" class="text-info mb-0">-</h4>
                            <small class="text-muted">Créditos Usados</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <i class="bi bi-percent text-warning fs-2"></i>
                            <h4 id="taxa-uso" class="text-warning mb-0">-</h4>
                            <small class="text-muted">Taxa de Uso</small>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2 progress-labels">
                        <small>Utilização dos créditos</small>
                        <small id="progresso-texto">0 de 0 usados</small>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div id="barra-progresso" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card how-it-works-card">
            <div class="card-header">
                <h5><i class="bi bi-info-circle me-2"></i>Como Funciona o Sistema</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-start mb-3">
                            <div class="info-icon icon-success me-3 flex-shrink-0">
                                <i class="bi bi-check-lg text-white"></i>
                            </div>
                            <div>
                                <strong>1 crédito = 1 correção</strong>
                                <br><small class="text-muted">Cada correção de simulado consome exatamente 1 crédito</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-start mb-3">
                            <div class="info-icon icon-primary me-3 flex-shrink-0">
                                <i class="bi bi-send text-white"></i>
                            </div>
                            <div>
                                <strong>Consumo automático</strong>
                                <br><small class="text-muted">Crédito é descontado automaticamente ao processar a correção</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-start mb-3">
                            <div class="info-icon icon-secondary me-3 flex-shrink-0">
                                <i class="bi bi-smartphone text-white"></i>
                            </div>
                            <div>
                                <strong>Sincronização automática</strong>
                                <br><small class="text-muted">Créditos sincronizam entre web e app mobile</small>
                            </div>
                        </div>
                        <div class="p-3 rounded guarantee-box">
                            <small class="text-muted">
                                <i class="bi bi-shield-check text-success me-2"></i>
                                <strong>Garantia:</strong> Créditos nunca expiram e são protegidos contra perda
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card plans-card">
            <div class="card-header text-center">
                <h5><i class="bi bi-bag-plus me-2"></i>Planos de Créditos</h5>
                <p class="text-muted text-plan-description mb-0">Compre créditos através do aplicativo mobile (Google Play ou App Store)</p>
            </div>
            <div class="card-body">
                <div class="row justify-content-center">
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card h-100 pricing-card">
                            <div class="card-header text-center">
                                <h5 class="mb-2">📚 Starter</h5>
                                <small>Professores iniciantes</small>
                            </div>
                            <div class="card-body text-center d-flex flex-column">
                                <div class="mb-3">
                                    <div class="display-4 text-primary fw-bold">300</div>
                                    <p class="text-muted mb-2">correções</p>
                                </div>
                                <div class="mb-3"><span class="h3 price">R$ 14,90</span></div>
                                <div class="mb-3"><span class="badge"><i class="bi bi-calculator"></i> R$ 0,050 por correção</span></div>
                                <div class="mt-auto">
                                    <div class="alert alert-info py-2">
                                        <small><i class="bi bi-phone"></i> Disponível no app</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card h-100 pricing-card plan-essencial">
                            <div class="position-absolute top-0 start-50 translate-middle">
                                <span class="badge popular-badge px-3 py-2"><i class="bi bi-star-fill"></i> MAIS POPULAR</span>
                            </div>
                            <div class="card-header text-center">
                                <h5 class="mb-2">🎯 Professor Ativo</h5>
                                <small>Uso regular em aula</small>
                            </div>
                            <div class="card-body text-center d-flex flex-column">
                                <div class="mb-3">
                                    <div class="display-4 text-success fw-bold">800</div>
                                    <p class="text-muted mb-2">correções</p>
                                </div>
                                <div class="mb-3"><span class="h3 price">R$ 29,90</span><br><small class="text-muted">Economia de 26%</small></div>
                                <div class="mb-3"><span class="badge"><i class="bi bi-calculator"></i> R$ 0,037 por correção</span></div>
                                <div class="mt-auto">
                                    <div class="alert alert-info py-2">
                                        <small><i class="bi bi-phone"></i> Disponível no app</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card h-100 pricing-card">
                            <div class="card-header text-center">
                                <h5 class="mb-2">🏫 Escola Pequena</h5>
                                <small>Até 200 alunos</small>
                            </div>
                            <div class="card-body text-center d-flex flex-column">
                                <div class="mb-3">
                                    <div class="display-4 text-warning fw-bold">2000</div>
                                    <p class="text-muted mb-2">correções</p>
                                </div>
                                <div class="mb-3"><span class="h3 price">R$ 59,90</span><br><small class="text-muted">Economia de 40%</small></div>
                                <div class="mb-3"><span class="badge"><i class="bi bi-calculator"></i> R$ 0,030 por correção</span></div>
                                <div class="mt-auto">
                                    <div class="alert alert-info py-2">
                                        <small><i class="bi bi-phone"></i> Disponível no app</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card h-100 pricing-card">
                            <div class="card-header text-center">
                                <h5 class="mb-2">🏢 Escola Profissional</h5>
                                <small>Instituições grandes</small>
                            </div>
                            <div class="card-body text-center d-flex flex-column">
                                <div class="mb-3">
                                    <div class="display-4 text-danger fw-bold">5000</div>
                                    <p class="text-muted mb-2">correções</p>
                                </div>
                                <div class="mb-3"><span class="h3 price">R$ 99,90</span><br><small class="text-muted">Economia de 50%</small></div>
                                <div class="mb-3"><span class="badge"><i class="bi bi-calculator"></i> R$ 0,020 por correção</span></div>
                                <div class="mt-auto">
                                    <div class="alert alert-info py-2">
                                        <small><i class="bi bi-phone"></i> Disponível no app</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-12">
        <div class="card faq-card">
            <div class="card-header">
                <h5><i class="bi bi-question-circle me-2"></i>Perguntas Frequentes</h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="faqAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                <i class="bi bi-clock me-2 text-warning"></i> Os créditos expiram?
                            </button>
                        </h2>
                        <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                <strong>Não!</strong> Seus créditos nunca expiram e podem ser usados a qualquer momento.
                                Eles ficam salvos na sua conta permanentemente.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                <i class="bi bi-arrow-repeat me-2 text-success"></i> Como funcionam as sincronizações?
                            </button>
                        </h2>
                        <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Os créditos são sincronizados automaticamente entre o site e o aplicativo mobile.
                                Quando você compra no app, aparecem aqui no site instantaneamente.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                <i class="bi bi-credit-card me-2 text-primary"></i> Como comprar mais créditos?
                            </button>
                        </h2>
                        <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Use o aplicativo móvel SimuladoApp. Toque no ícone de carteira e escolha o plano.
                                O pagamento é processado pela Google Play (Android) ou App Store (iOS).
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                                <i class="bi bi-shield-check me-2 text-info"></i> É seguro comprar?
                            </button>
                        </h2>
                        <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Sim! Todas as compras são processadas pelas lojas oficiais (Google Play/App Store)
                                com criptografia e proteção total dos seus dados financeiros.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// JavaScript para carregar os dados reais de créditos
// JavaScript para carregar os dados reais de créditos
document.addEventListener('DOMContentLoaded', function() {
    // Carregar dados iniciais
    carregarSaldo();
});

// Função para carregar o saldo atual de créditos
async function carregarSaldo() {
    const btnRefresh = document.getElementById('btn-refresh');
    const saldoElement = document.getElementById('saldo-creditos');
    const totalCreditosElement = document.getElementById('total-creditos');
    const creditosUsadosElement = document.getElementById('creditos-usados');
    const taxaUsoElement = document.getElementById('taxa-uso');
    const barraProgressoElement = document.getElementById('barra-progresso');
    const progressoTextoElement = document.getElementById('progresso-texto');

    try {
        // Mostrar loading
        btnRefresh.disabled = true;
        btnRefresh.innerHTML = '<i class="bi bi-arrow-clockwise spinner-border spinner-border-sm"></i> Carregando...';

        // Fazer requisição para a API
        const response = await fetch('/api/creditos/', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });

        if (!response.ok) {
            // Se erro 404 ou 500, mostrar 0 créditos
            console.warn(`Resposta não OK: ${response.status}`);
            mostrarSaldoZero();
            return;
        }

        const data = await response.json();

        // Verificar se há erro na resposta
        if (data.error) {
            console.error('Erro na resposta:', data.error);
            mostrarSaldoZero();
            return;
        }

        // Atualizar saldo principal
        const creditosRestantes = data.creditos_restantes || 0;
        saldoElement.innerHTML = `<span class="counter">${creditosRestantes}</span>`;

        // Atualizar estatísticas
        const totalCreditos = data.total_creditos || 0;
        const usadosCreditos = data.usados_creditos || 0;

        totalCreditosElement.textContent = totalCreditos;
        creditosUsadosElement.textContent = usadosCreditos;

        // Calcular taxa de uso
        const taxaUso = totalCreditos > 0 ? ((usadosCreditos / totalCreditos) * 100).toFixed(1) : 0;
        taxaUsoElement.textContent = `${taxaUso}%`;

        // Atualizar barra de progresso
        const porcentagemUso = totalCreditos > 0 ? (usadosCreditos / totalCreditos) * 100 : 0;
        barraProgressoElement.style.width = `${porcentagemUso}%`;
        progressoTextoElement.textContent = `${usadosCreditos} de ${totalCreditos} usados`;

        // Animação do contador
        animarContador(saldoElement.querySelector('.counter'), creditosRestantes);

        console.log('Dados de créditos carregados:', data);

    } catch (error) {
        console.error('Erro ao carregar saldo:', error);
        mostrarSaldoZero();

    } finally {
        // Restaurar botão
        btnRefresh.disabled = false;
        btnRefresh.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Atualizar';
    }
}

// Função para mostrar saldo zero quando não há dados
function mostrarSaldoZero() {
    const saldoElement = document.getElementById('saldo-creditos');
    const totalCreditosElement = document.getElementById('total-creditos');
    const creditosUsadosElement = document.getElementById('creditos-usados');
    const taxaUsoElement = document.getElementById('taxa-uso');
    const barraProgressoElement = document.getElementById('barra-progresso');
    const progressoTextoElement = document.getElementById('progresso-texto');

    // Mostrar 0 em todos os campos
    saldoElement.innerHTML = '<span class="counter">0</span>';
    totalCreditosElement.textContent = '0';
    creditosUsadosElement.textContent = '0';
    taxaUsoElement.textContent = '0%';
    barraProgressoElement.style.width = '0%';
    progressoTextoElement.textContent = '0 de 0 usados';

    console.info('Usuário sem créditos. Exibindo saldo zero.');
}

// Função para animar contador
function animarContador(elemento, valorFinal) {
    if (!elemento) return;

    const valorInicial = 0;
    const duracao = 1000; // 1 segundo
    const incremento = valorFinal / (duracao / 16); // ~60fps
    let valorAtual = valorInicial;

    const timer = setInterval(() => {
        valorAtual += incremento;
        if (valorAtual >= valorFinal) {
            elemento.textContent = valorFinal;
            clearInterval(timer);
        } else {
            elemento.textContent = Math.floor(valorAtual);
        }
    }, 16);
}

// Função para atualizar dados periodicamente (opcional)
function iniciarAtualizacaoAutomatica() {
    // Atualizar a cada 5 minutos
    setInterval(carregarSaldo, 5 * 60 * 1000);
}

// Função para formatar números com separador de milhares
function formatarNumero(numero) {
    return numero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// Adicionar listeners para botões de atualização
document.addEventListener('click', function(e) {
    if (e.target.closest('[onclick*="carregarSaldo"]')) {
        e.preventDefault();
        carregarSaldo();
    }
});

// Função para mostrar toast personalizado (opcional)
function showToast(mensagem, tipo = 'info') {
    console.log(`Toast [${tipo}]: ${mensagem}`);

    // Se existir Bootstrap Toast, usar aqui
    // Caso contrário, apenas log
}

// Inicialização automática (opcional - descomentar se desejar)
// iniciarAtualizacaoAutomatica();
</script>
{% endblock %}

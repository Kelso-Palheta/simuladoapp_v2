{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - {{ plan.name }} - {{ block.super }}{% endblock %}

{% block extra_head %}
<style>
    .checkout-wrapper {
        min-height: calc(100vh - 200px);
        padding: 60px 0;
    }
    
    .checkout-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    /* Header */
    .checkout-header {
        text-align: center;
        margin-bottom: 50px;
    }
    
    .checkout-header h1 {
        font-family: var(--font-title);
        font-size: 2.8rem;
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -moz-background-clip: text;
        background-clip: text;
        color: transparent;
        margin-bottom: 15px;
        letter-spacing: 1px;
    }
    
    .checkout-header p {
        color: var(--text-muted);
        font-size: 1.15rem;
    }
    
    /* Layout Grid */
    .checkout-grid {
        display: grid;
        grid-template-columns: 1fr 420px;
        gap: 40px;
        align-items: start;
    }
    
    @media (max-width: 992px) {
        .checkout-grid {
            grid-template-columns: 1fr;
        }
        
        .order-summary-card {
            order: -1;
        }
    }
    
    /* Cards Base */
    .checkout-card {
        background-color: var(--bg-surface);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }
    
    [data-theme="dark"] .checkout-card {
        background: linear-gradient(145deg, rgba(30, 32, 58, 0.5), rgba(30, 32, 58, 0.2));
        backdrop-filter: blur(10px);
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
    }
    
    .checkout-card h3 {
        font-family: var(--font-title);
        font-size: 1.8rem;
        color: var(--color-primary);
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .checkout-card h3 i {
        font-size: 1.6rem;
    }
    
    /* Order Summary - Sticky */
    .order-summary-card {
        position: sticky;
        top: 100px;
    }
    
    .plan-badge {
        display: inline-block;
        padding: 8px 20px;
        background: linear-gradient(135deg, rgba(0, 164, 217, 0.15), rgba(67, 72, 145, 0.15));
        border: 1px solid var(--color-primary);
        border-radius: 50px;
        color: var(--color-primary);
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        margin-bottom: 20px;
    }
    
    .plan-name-display {
        font-family: var(--font-title);
        font-size: 2rem;
        color: var(--text-primary);
        margin-bottom: 25px;
        line-height: 1.2;
    }
    
    /* Price Display */
    .price-box {
        background: var(--accent-gradient);
        border-radius: 16px;
        padding: 35px;
        text-align: center;
        margin: 30px 0;
        position: relative;
        overflow: hidden;
    }
    
    .price-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
        pointer-events: none;
    }
    
    .price-box .price-amount {
        font-size: 3.5rem;
        font-weight: 700;
        color: white;
        line-height: 1;
        position: relative;
    }
    
    .price-box .currency {
        font-size: 2rem;
        vertical-align: super;
        margin-right: 5px;
    }
    
    .price-box .billing-period {
        color: rgba(255, 255, 255, 0.95);
        font-size: 1.2rem;
        margin-top: 12px;
        position: relative;
    }
    
    /* Features List */
    .features-list {
        list-style: none;
        padding: 0;
        margin: 30px 0;
    }
    
    .features-list li {
        padding: 15px 0;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: flex-start;
        gap: 15px;
        color: var(--text-primary);
        transition: all 0.2s ease;
    }
    
    .features-list li:last-child {
        border-bottom: none;
    }
    
    .features-list li:hover {
        padding-left: 10px;
        background: rgba(0, 164, 217, 0.05);
        border-radius: 8px;
    }
    
    .features-list li i {
        color: var(--color-success);
        font-size: 1.3rem;
        flex-shrink: 0;
        margin-top: 3px;
    }
    
    /* Info Alert */
    .renewal-info {
        background: rgba(59, 130, 246, 0.1);
        border-left: 4px solid var(--color-info);
        border-radius: 8px;
        padding: 20px;
        margin-top: 30px;
    }
    
    .renewal-info i {
        color: var(--color-info);
        font-size: 1.3rem;
        margin-right: 10px;
    }
    
    .renewal-info strong {
        display: block;
        margin-bottom: 8px;
        color: var(--text-primary);
    }
    
    .renewal-info p {
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.6;
    }
    
    /* Payment Form */
    .form-section {
        margin-bottom: 35px;
    }
    
    .form-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .form-section-title i {
        color: var(--color-primary);
        font-size: 1.2rem;
    }
    
    /* Stripe Card Element */
    .stripe-card-wrapper {
        position: relative;
    }
    
    #card-element {
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 18px;
        background-color: var(--bg-surface);
        transition: all 0.3s ease;
        min-height: 50px;
    }
    
    #card-element:hover {
        border-color: var(--color-primary);
    }
    
    #card-element.StripeElement--focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 4px rgba(0, 164, 217, 0.15);
    }
    
    #card-element.StripeElement--invalid {
        border-color: var(--color-danger);
    }
    
    #card-errors {
        color: var(--color-danger);
        margin-top: 12px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    #card-errors i {
        font-size: 1.1rem;
    }
    
    /* Terms Checkbox */
    .terms-box {
        background: var(--bg-main);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 20px;
        margin: 30px 0;
    }
    
    .terms-checkbox-wrapper {
        display: flex;
        align-items: start;
        gap: 12px;
        cursor: pointer;
    }
    
    .terms-checkbox-wrapper input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        margin-top: 2px;
        accent-color: var(--color-primary);
    }
    
    .terms-checkbox-wrapper label {
        cursor: pointer;
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--text-primary);
        margin: 0;
    }
    
    .terms-checkbox-wrapper a {
        color: var(--color-primary);
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .terms-checkbox-wrapper a:hover {
        text-decoration: underline;
        color: var(--color-secondary);
    }
    
    /* Submit Button */
    .btn-checkout-submit {
        width: 100%;
        padding: 20px;
        font-size: 1.3rem;
        font-weight: 700;
        background: var(--accent-gradient);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        box-shadow: 0 6px 20px rgba(0, 164, 217, 0.3);
        position: relative;
        overflow: hidden;
    }
    
    .btn-checkout-submit::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .btn-checkout-submit:hover:not(:disabled)::before {
        left: 100%;
    }
    
    .btn-checkout-submit:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 164, 217, 0.5);
    }
    
    .btn-checkout-submit:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-checkout-submit i {
        font-size: 1.5rem;
    }
    
    .btn-checkout-submit .spinner {
        display: none;
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    .btn-checkout-submit.loading .spinner {
        display: inline-block;
    }
    
    .btn-checkout-submit.loading .btn-text {
        opacity: 0.7;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Security Badges */
    .security-badges {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 25px;
        margin-top: 35px;
        padding-top: 30px;
        border-top: 1px solid var(--border-color);
    }
    
    .security-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-muted);
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .security-badge i {
        color: var(--color-success);
        font-size: 1.4rem;
    }
    
    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
    }
    
    .loading-overlay.active {
        display: flex;
    }
    
    .loading-content {
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        padding: 50px 60px;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
    }
    
    .loading-content .spinner-large {
        width: 60px;
        height: 60px;
        border: 5px solid var(--border-color);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 25px;
    }
    
    .loading-content h4 {
        color: var(--text-primary);
        font-family: var(--font-title);
        font-size: 1.5rem;
        margin-bottom: 10px;
    }
    
    .loading-content p {
        color: var(--text-muted);
        margin: 0;
        font-size: 1rem;
    }
    
    /* Back Button */
    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--text-muted);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s ease;
        margin-bottom: 20px;
    }
    
    .btn-back:hover {
        color: var(--color-primary);
        transform: translateX(-5px);
    }
    
    .btn-back i {
        font-size: 1.2rem;
    }
</style>
{% endblock %}

{% block content %}

<div class="checkout-wrapper">
    <div class="checkout-container">
        <!-- Back Button -->
        <a href="{% url 'payments:subscription_detail' %}" class="btn-back">
            <i class="bi bi-arrow-left"></i>
            <span>Voltar para planos</span>
        </a>
        
        <!-- Header -->
        <div class="checkout-header">
            <h1><i class="bi bi-cart-check"></i> Finalizar Assinatura</h1>
            <p>Complete seu pedido de forma rápida e segura</p>
        </div>

        <!-- Grid Layout -->
        <div class="checkout-grid">
            <!-- Payment Form -->
            <div class="checkout-card">
                <h3>
                    <i class="bi bi-credit-card-2-front"></i>
                    Informações de Pagamento
                </h3>

                <form id="checkout-form">
                    {% csrf_token %}
                    
                    <!-- Card Information Section -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="bi bi-shield-lock"></i>
                            <span>Dados do Cartão de Crédito</span>
                        </div>
                        
                        <div class="stripe-card-wrapper">
                            <div id="card-element"></div>
                            <div id="card-errors" role="alert"></div>
                        </div>
                        
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-info-circle"></i>
                            Seus dados são protegidos com criptografia SSL de ponta a ponta
                        </small>
                    </div>

                    <!-- Terms & Conditions -->
                    <div class="terms-box">
                        <div class="terms-checkbox-wrapper">
                            <input type="checkbox" id="terms-checkbox" required>
                            <label for="terms-checkbox">
                                Eu li e concordo com os 
                                <a href="#" target="_blank">Termos de Serviço</a>, 
                                <a href="#" target="_blank">Política de Privacidade</a> e 
                                <a href="#" target="_blank">Política de Reembolso</a>
                            </label>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submit-button" class="btn-checkout-submit">
                        <i class="bi bi-lock-fill"></i>
                        <span class="btn-text">Confirmar e Pagar</span>
                        <span class="spinner"></span>
                    </button>

                    <!-- Security Badges -->
                    <div class="security-badges">
                        <div class="security-badge">
                            <i class="bi bi-shield-check"></i>
                            <span>Pagamento 100% Seguro</span>
                        </div>
                        <div class="security-badge">
                            <i class="bi bi-lock-fill"></i>
                            <span>Criptografia SSL</span>
                        </div>
                        <div class="security-badge">
                            <i class="bi bi-credit-card"></i>
                            <span>Powered by Stripe</span>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Order Summary -->
            <div class="checkout-card order-summary-card">
                <h3>
                    <i class="bi bi-receipt"></i>
                    Resumo do Pedido
                </h3>

                <span class="plan-badge">{{ plan.get_plan_type_display }}</span>
                <h2 class="plan-name-display">{{ plan.name }}</h2>

                <!-- Price Display -->
                <div class="price-box">
                    <div class="price-amount">
                        <span class="currency">R$</span>{{ plan.price|floatformat:2 }}
                    </div>
                    <div class="billing-period">
                        por {{ plan.get_billing_period_display|lower }}
                    </div>
                </div>

                <!-- Features -->
                <div class="form-section-title">
                    <i class="bi bi-star-fill"></i>
                    <span>Recursos Incluídos</span>
                </div>
                
                <ul class="features-list">
                    {% for feature in features %}
                    <li>
                        <i class="bi bi-check-circle-fill"></i>
                        <span>{{ feature }}</span>
                    </li>
                    {% endfor %}
                </ul>

                <!-- Renewal Info -->
                <div class="renewal-info">
                    <strong>
                        <i class="bi bi-arrow-repeat"></i>
                        Renovação Automática
                    </strong>
                    <p>
                        Sua assinatura será renovada automaticamente a cada 
                        {{ plan.get_billing_period_display|lower }}. 
                        Você pode cancelar a qualquer momento sem custos adicionais.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner-large"></div>
        <h4>Processando Pagamento</h4>
        <p>Por favor, aguarde enquanto processamos seu pagamento...</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    // Inicializa Stripe
    const stripe = Stripe('{{ stripe_public_key }}');
    // ADICIONE ESTA LINHA ABAIXO
    console.log('Chave Pública do Stripe usada:', '{{ stripe_public_key }}');
    const elements = stripe.elements();
    
    // Estilo personalizado para o Stripe Card Element
    const cardStyle = {
        base: {
            color: getComputedStyle(document.documentElement)
                .getPropertyValue('--text-primary').trim(),
            fontFamily: '"Poppins", sans-serif',
            fontSmoothing: 'antialiased',
            fontSize: '16px',
            '::placeholder': {
                color: getComputedStyle(document.documentElement)
                    .getPropertyValue('--text-muted').trim()
            }
        },
        invalid: {
            color: '#ef4444',
            iconColor: '#ef4444'
        }
    };
    
    // Cria e monta o card element
    const cardElement = elements.create('card', {
        style: cardStyle,
        hidePostalCode: true
    });
    cardElement.mount('#card-element');
    
    // Listener para mudanças no card element
    cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.innerHTML = `
                <i class="bi bi-exclamation-circle"></i>
                <span>${event.error.message}</span>
            `;
        } else {
            displayError.textContent = '';
        }
    });
    
    // Handle submit do formulário
    const form = document.getElementById('checkout-form');
    const submitButton = document.getElementById('submit-button');
    const loadingOverlay = document.getElementById('loading-overlay');
    const termsCheckbox = document.getElementById('terms-checkbox');
    
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        // Valida checkbox de termos
        if (!termsCheckbox.checked) {
            alert('Por favor, aceite os termos de serviço para continuar.');
            termsCheckbox.focus();
            return;
        }
        
        // Desabilita botão e exibe loading
        submitButton.disabled = true;
        submitButton.classList.add('loading');
        loadingOverlay.classList.add('active');
        
        try {
            // Cria checkout session no backend
            const response = await fetch('{% url "payments:create_checkout_session" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    plan_slug: '{{ plan.slug }}'
                })
            });
            
            const data = await response.json();
            
            if (!response.ok || data.error) {
                throw new Error(data.error || 'Erro ao criar sessão de pagamento');
            }
            
            // Redireciona para o Stripe Checkout
            const result = await stripe.redirectToCheckout({
                sessionId: data.sessionId
            });
            
            if (result.error) {
                throw new Error(result.error.message);
            }
            
        } catch (error) {
            console.error('Erro no checkout:', error);
            alert('Erro ao processar pagamento: ' + error.message);
            
            // Re-habilita o botão
            submitButton.disabled = false;
            submitButton.classList.remove('loading');
            loadingOverlay.classList.remove('active');
        }
    });
    
    // Atualiza estilo do Stripe ao mudar tema
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'data-theme') {
                cardElement.update({
                    style: {
                        base: {
                            color: getComputedStyle(document.documentElement)
                                .getPropertyValue('--text-primary').trim()
                        }
                    }
                });
            }
        });
    });
    
    observer.observe(document.documentElement, {
        attributes: true
    });
</script>
{% endblock %}
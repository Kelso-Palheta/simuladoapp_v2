{% extends 'base.html' %}
{% load static %}

{% block title %}Gerando PDF - {{ simulado.titulo }}{% endblock %}

{% block content %}
<div class="progress-container">
    <h1 class="progress-title">
        <i class="bi bi-arrow-clockwise spin-animation me-2"></i>
        Gerando PDF do Simulado
    </h1>

    <div class="simulado-info">
        <strong class="simulado-name">{{ simulado.titulo }}</strong><br>
        <small class="simulado-details">{{ simulado.questoes.count }} questões</small>
    </div>

    <!-- Barra de progresso moderna -->
    <div class="progress-bar-container">
        <div id="progress-bar" class="progress-bar-fill">
            <!-- Efeito de brilho animado -->
            <div class="progress-shine"></div>
        </div>
        <div id="progress-text" class="progress-percentage">0%</div>
    </div>

    <div id="progress-status" class="progress-status loading-pulse">
        <div id="progress-message" class="progress-message">Preparando geração do PDF...</div>
    </div>

    <div id="completed-actions" class="completed-actions">
        <button id="back-button" class="btn btn-primary btn-lg">
            <i class="bi bi-arrow-left me-2"></i>
            Voltar para Lista de Simulados
        </button>
    </div>
</div>

<style>
/* Container principal */
.progress-container {
    max-width: 600px;
    margin: 0 auto;
    background-color: var(--bg-surface);
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border: 1px solid var(--border-color);
}

[data-theme="dark"] .progress-container {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
}

/* Título */
.progress-title {
    color: var(--color-primary);
    margin-bottom: 20px;
    text-align: center;
    font-family: var(--font-title);
    font-size: 1.8rem;
}

/* Informações do simulado */
.simulado-info {
    background-color: var(--bg-main);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    border: 1px solid var(--border-color);
    text-align: center;
}

.simulado-name {
    color: var(--text-primary);
    font-size: 1.1rem;
}

.simulado-details {
    color: var(--text-muted);
}

/* Container da barra de progresso */
.progress-bar-container {
    width: 100%;
    height: 40px;
    background-color: #e0e7f0; /* Cinza claro fixo no tema claro */
    border: 3px solid var(--color-primary);
    border-radius: 20px;
    position: relative;
    margin: 30px 0;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

[data-theme="dark"] .progress-bar-container {
    background-color: #b8c5d9; /* Cinza claro também no tema escuro */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

/* Barra de progresso preenchida - azul claro */
.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #4dd0e1, #00bcd4); /* Azul claro/ciano */
    width: 0%;
    transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 17px;
    box-shadow: 0 0 15px rgba(77, 208, 225, 0.5);
    position: relative;
}

[data-theme="dark"] .progress-bar-fill {
    background: linear-gradient(90deg, #00a4d9, #4dd0e1); /* Azul médio no tema escuro */
    box-shadow: 0 0 15px rgba(0, 164, 217, 0.6);
}

/* Efeito de brilho na barra - mais sutil */
.progress-shine {
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shine 2.5s infinite;
}

/* Texto de porcentagem - SEMPRE PRETO */
.progress-percentage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #000000 !important; /* Sempre preto */
    font-weight: bold;
    font-size: 18px;
    z-index: 100;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5); /* Sombra branca para contraste */
    pointer-events: none;
    letter-spacing: 0.5px;
}

/* Status do progresso */
.progress-status {
    margin: 30px 0;
    padding: 20px;
    background-color: var(--bg-main);
    border-radius: 8px;
    border-left: 4px solid var(--color-primary);
    transition: all 0.3s ease;
}

[data-theme="dark"] .progress-status {
    background-color: rgba(18, 20, 37, 0.5);
}

.progress-message {
    color: var(--text-primary);
    font-weight: 500;
}

/* Estados de sucesso e erro */
.progress-status.success {
    border-left-color: var(--color-success) !important;
    background-color: rgba(16, 185, 129, 0.1) !important;
}

[data-theme="dark"] .progress-status.success {
    background-color: rgba(45, 216, 163, 0.1) !important;
}

.progress-status.error {
    border-left-color: var(--color-danger) !important;
    background-color: rgba(239, 68, 68, 0.1) !important;
}

[data-theme="dark"] .progress-status.error {
    background-color: rgba(233, 75, 106, 0.1) !important;
}

/* Ações completadas */
.completed-actions {
    display: none;
    text-align: center;
    margin-top: 20px;
}

.completed-actions .btn {
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 600;
}

/* Animações */
@keyframes shine {
    0% { left: -100%; }
    100% { left: 100%; }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-pulse {
    animation: pulse 2s infinite;
}

.spin-animation {
    display: inline-block;
    animation: spin 2s linear infinite;
}

/* Responsividade */
@media (max-width: 768px) {
    .progress-container {
        padding: 20px;
        margin: 1rem;
    }

    .progress-title {
        font-size: 1.5rem;
    }

    .progress-bar-container {
        height: 35px;
    }

    .progress-percentage {
        font-size: 16px;
    }
}

/* Hover no botão */
.completed-actions .btn:hover {
    transform: translateY(-2px);
}
</style>

<script>
    let progressInterval;
    let simuladoPk = "{{ pk|escapejs }}";

    const statusUrl = "{% url 'questions:status_progresso' pk=999 %}".replace('999', simuladoPk);
    const generateUrl = "{% url 'questions:gerar_pdf' pk=999 %}".replace('999', simuladoPk);
    const backUrl = "{% url 'questions:simulado_list' %}";

    function updateProgress() {
        fetch(statusUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Progress data:', data);

                // Atualizar barra de progresso
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');

                if (progressBar && progressText) {
                    progressBar.style.width = data.percent + '%';
                    progressText.textContent = data.percent + '%';
                }

                // Atualizar mensagem
                const messageEl = document.getElementById('progress-message');
                messageEl.textContent = data.message;

                const statusDiv = document.getElementById('progress-status');
                statusDiv.classList.remove('loading-pulse');

                if (data.completed) {
                    // Remove classes antigas
                    statusDiv.classList.remove('success', 'error');

                    if (data.error) {
                        statusDiv.classList.add('error');
                        messageEl.innerHTML = '<i class="bi bi-x-circle me-2"></i>Erro: ' + data.error;
                    } else {
                        statusDiv.classList.add('success');
                        messageEl.innerHTML = '<i class="bi bi-check-circle me-2"></i>PDF gerado com sucesso!';
                        document.getElementById('completed-actions').style.display = 'block';

                        // Download automático
                        if (data.download_url) {
                            setTimeout(() => {
                                window.location.href = data.download_url;
                            }, 1000);
                        }
                    }
                    clearInterval(progressInterval);
                } else {
                    statusDiv.classList.add('loading-pulse');
                }
            })
            .catch(error => {
                console.error('Erro de conexão:', error);
                const statusDiv = document.getElementById('progress-status');
                const messageEl = document.getElementById('progress-message');

                statusDiv.classList.remove('loading-pulse', 'success');
                statusDiv.classList.add('error');
                messageEl.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Erro de conexão: ' + error.message;
                clearInterval(progressInterval);
            });
    }

    function startGeneration() {
        const urlParams = new URLSearchParams(window.location.search);
        const force = urlParams.get('force');

        let url = generateUrl;
        if (force) {
            url += '?force=true';
        }

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro ao iniciar geração: HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Geração iniciada:', data);
        })
        .catch(error => {
            console.error('Erro ao iniciar geração:', error);
            const statusDiv = document.getElementById('progress-status');
            const messageEl = document.getElementById('progress-message');

            statusDiv.classList.add('error');
            messageEl.innerHTML = '<i class="bi bi-x-circle me-2"></i>Erro ao iniciar: ' + error.message;
        });
    }

    // Configurar eventos
    document.addEventListener('DOMContentLoaded', function() {
        const backButton = document.getElementById('back-button');
        if (backButton) {
            backButton.addEventListener('click', function() {
                window.location.href = backUrl;
            });
        }

        // Adicionar animação de carregamento inicial
        document.getElementById('progress-status').classList.add('loading-pulse');
    });

    // Iniciar processo quando a página carregar
    window.addEventListener('load', function() {
        console.log('Iniciando progresso para simulado:', simuladoPk);
        progressInterval = setInterval(updateProgress, 1000);
        startGeneration();
    });

    // Cleanup ao sair da página
    window.addEventListener('beforeunload', function() {
        if (progressInterval) {
            clearInterval(progressInterval);
        }
    });
</script>
{% endblock %}
{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0" style="color: var(--color-primary);">{{ simulado.titulo }}</h2>
                <small class="text-muted">Gabarito Oficial para Correção</small>
            </div>
            <span class="badge bg-primary rounded-pill fs-6">{{ simulado.questoes.count }} questões</span>
        </div>
        <div class="card-body">
            {% if versao_oficial and versao_oficial.gabaritos_gerados %}
                <!-- AVISO SOBRE SISTEMA -->
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Gabarito Oficial:</strong> Este é o gabarito que será usado para correção automática das provas.
                    {% if versao_oficial != simulado.get_historico_gabaritos.first %}
                        <br><small class="text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Esta não é a versão mais recente. Você escolheu manualmente esta versão como oficial.
                        </small>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <small style="color: var(--text-secondary);">
                        <i class="bi bi-star-fill me-1 text-warning"></i>Versão Oficial: {{ versao_oficial.get_versao_curta }}
                        | <i class="bi bi-clock me-1"></i>Gerada em: {{ versao_oficial.data_geracao|date:"d/m/Y \à\s H:i" }}
                        | Total de questões: {{ versao_oficial.total_questoes }}
                        {% if versao_oficial.usuario_geracao %}
                        | Por: {{ versao_oficial.usuario_geracao.get_full_name|default:versao_oficial.usuario_geracao.username }}
                        {% endif %}
                    </small>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col" class="text-end pe-3">Questão</th>
                                <th scope="col" class="text-center">Tipo 1</th>
                                <th scope="col" class="text-center">Tipo 2</th>
                                <th scope="col" class="text-center">Tipo 3</th>
                                <th scope="col" class="text-center">Tipo 4</th>
                                <th scope="col" class="text-center">Tipo 5</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in gabaritos_processados %}
                            <tr>
                                <td class="text-end pe-3 questao-numero">{{ row.questao_idx }}</td>
                                <td class="text-center alternativa">{{ row.versao_1 }}</td>
                                <td class="text-center alternativa">{{ row.versao_2 }}</td>
                                <td class="text-center alternativa">{{ row.versao_3 }}</td>
                                <td class="text-center alternativa">{{ row.versao_4 }}</td>
                                <td class="text-center alternativa">{{ row.versao_5 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <!-- Estado sem gabarito oficial -->
                <div class="alert alert-warning text-center">
                    <i class="bi bi-exclamation-triangle fa-2x mb-3"></i>
                    <h4 class="alert-heading">Nenhum Gabarito Oficial Definido</h4>
                    <p>
                        Para que as correções automáticas funcionem, é necessário definir um gabarito como oficial.
                        Gere um novo PDF ou acesse o histórico para definir uma versão existente como oficial.
                    </p>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>Dica:</strong> Toda nova geração de PDF automaticamente vira a versão oficial.
                    </div>
                    <hr>
                    <div class="btn-group">
                        <a href="{% url 'questions:progresso_pdf' pk=simulado.pk %}" class="btn btn-primary btn-lg">
                            <i class="bi bi-file-pdf me-2"></i> Gerar Novo PDF (Vira Oficial)
                        </a>
                        {% if total_versoes > 0 %}
                        <a href="{% url 'questions:simulado_gabaritos_historico' simulado.pk %}" class="btn btn-outline-primary btn-lg">
                            <i class="bi bi-star me-2"></i> Escolher Versão Oficial
                        </a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
        <div class="card-footer">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                <div class="btn-group">
                    <a href="{% url 'questions:simulado_list' %}" class="btn btn-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i> Voltar
                    </a>
                    <a href="{% url 'questions:simulado_edit' simulado.id %}" class="btn btn-secondary btn-sm">
                        <i class="bi bi-pencil me-1"></i> Editar
                    </a>
                    <a href="{% url 'questions:progresso_pdf' pk=simulado.pk %}" class="btn btn-info btn-sm">
                        <i class="bi bi-download me-1"></i> Baixar PDF (Novo Embaralhamento)
                    </a>
                    {% if total_versoes > 0 %}
                    <a href="{% url 'questions:simulado_gabaritos_historico' simulado.pk %}" class="btn btn-secondary btn-sm">
                        <i class="bi bi-clock-history me-1"></i> Histórico ({{ total_versoes }})
                    </a>
                    {% endif %}
                </div>
                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="bi bi-trash me-1"></i> Excluir Simulado
                </button>
            </div>
        </div>
    </div>

    {% if total_versoes > 0 %}
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title stats-title">
                <i class="bi bi-graph-up me-2"></i>Estatísticas de Geração
            </h5>
            <div class="row">
                <div class="col-md-3">
                    <div class="text-center stats-item">
                        <h3 class="stats-number-primary">{{ total_versoes }}</h3>
                        <small class="stats-label">Versões Geradas</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center stats-item">
                        <h3 class="stats-number-success">{{ simulado.questoes.count }}</h3>
                        <small class="stats-label">Questões no Simulado</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center stats-item">
                        <h3 class="stats-number-warning">{{ versao_oficial.get_versao_curta|default:"--" }}</h3>
                        <small class="stats-label">Versão Oficial Atual</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center stats-item">
                        <h3 class="stats-number-info">∞</h3>
                        <small class="stats-label">Embaralhamentos Possíveis</small>
                    </div>
                </div>
            </div>

            <!-- Informações adicionais sobre a versão oficial -->
            {% if versao_oficial %}
            <hr class="my-3">
            <div class="row">
                <div class="col-md-6">
                    <small style="color: var(--text-secondary);">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Versão Oficial:</strong> {{ versao_oficial.get_versao_curta }}
                        {% if versao_oficial.usuario_geracao %}
                        (por {{ versao_oficial.usuario_geracao.get_full_name|default:versao_oficial.usuario_geracao.username }})
                        {% endif %}
                    </small>
                </div>
                <div class="col-md-6">
                    <small style="color: var(--text-secondary);">
                        <i class="bi bi-calendar me-1"></i>
                        <strong>Definida em:</strong> {{ versao_oficial.data_geracao|date:"d/m/Y \à\s H:i" }}
                    </small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o simulado <strong>"{{ simulado.titulo }}"</strong>?</p>
                <p class="text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Esta ação é irreversível e removerá todos os dados associados.</p>
                {% if versao_oficial %}
                <p class="text-warning">
                    <i class="bi bi-star me-2"></i>
                    Isso também excluirá a versão oficial <strong>{{ versao_oficial.get_versao_curta }}</strong>
                    e todas as {{ total_versoes }} versões de gabarito geradas.
                </p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a href="{% url 'questions:simulado_delete' simulado.pk %}" class="btn btn-danger">
                    <i class="bi bi-trash me-2"></i>Excluir Definitivamente
                </a>
            </div>
        </div>
    </div>
</div>

<style>
/* --- Tabela de Gabaritos --- */
.table {
    color: var(--text-primary);
    border-color: var(--border-color);
}

.table thead th {
    color: var(--text-secondary);
    background-color: var(--bg-main);
    border-bottom: 2px solid var(--border-color);
    font-weight: 600;
}

.table tbody tr {
    border-bottom: 1px solid var(--border-color);
}

.table tbody tr td {
    color: var(--text-primary) !important;
}

.table-striped>tbody>tr:nth-of-type(odd) {
    background-color: var(--bg-surface-hover) !important;
}

.table-striped>tbody>tr:nth-of-type(odd)>* {
    background-color: var(--bg-surface-hover) !important;
}

.table-striped>tbody>tr:nth-of-type(even) {
    background-color: var(--bg-surface) !important;
}

.table-striped>tbody>tr:nth-of-type(even)>* {
    background-color: var(--bg-surface) !important;
}

.table-hover>tbody>tr:hover {
    background-color: var(--bg-main) !important;
}

.table-hover>tbody>tr:hover>* {
    background-color: var(--bg-main) !important;
}

[data-theme="dark"] .table tbody tr {
    background-color: var(--bg-main);
}

[data-theme="dark"] .table tbody tr td {
    background-color: var(--bg-main) !important;
}

[data-theme="dark"] .table-striped>tbody>tr:nth-of-type(odd) {
    background-color: rgba(30, 32, 58, 0.3) !important;
}

[data-theme="dark"] .table-striped>tbody>tr:nth-of-type(odd)>* {
    background-color: rgba(30, 32, 58, 0.3) !important;
}

[data-theme="dark"] .table-hover>tbody>tr:hover {
    background-color: var(--bg-surface) !important;
}

[data-theme="dark"] .table-hover>tbody>tr:hover>* {
    background-color: var(--bg-surface) !important;
}

.table td, .table th {
    vertical-align: middle;
}

.table-responsive {
    overflow-x: auto;
}

.table {
    margin-bottom: 0;
}

/* Estilos para a tabela de gabaritos */
.questao-numero {
    width: 80px;
    font-weight: 500;
}

.alternativa {
    font-family: monospace;
    font-size: 1.1em;
    width: calc((100% - 80px) / 5);
}

/* Alertas adaptados ao tema */
.alert-info {
    background-color: rgba(59, 130, 246, 0.1);
    border-color: var(--color-info);
    color: var(--color-info);
}

[data-theme="dark"] .alert-info {
    background-color: rgba(13, 202, 240, 0.1);
    border-color: #0dcaf0;
    color: #0dcaf0;
}

.alert-warning {
    background-color: rgba(245, 158, 11, 0.1);
    border-color: var(--color-warning);
    color: #92400e;
}

[data-theme="dark"] .alert-warning {
    background-color: rgba(255, 193, 7, 0.1);
    border-color: var(--color-warning);
    color: var(--color-warning);
}

.alert-warning .text-warning {
    color: var(--color-warning) !important;
}

.alert .bi {
    color: inherit;
}

/* Estilos para as estatísticas */
.stats-title {
    color: var(--text-primary) !important;
    font-weight: 600;
}

.stats-item {
    padding: 1rem;
    border-radius: 8px;
    background-color: var(--bg-surface-hover);
    border: 1px solid var(--border-color);
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

[data-theme="dark"] .stats-item {
    background: rgba(255,255,255,0.05);
}

.stats-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

[data-theme="dark"] .stats-item:hover {
    background: rgba(255,255,255,0.1);
}

.stats-number-primary {
    color: var(--color-primary) !important;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

[data-theme="dark"] .stats-number-primary {
    text-shadow: 0 0 10px rgba(0, 164, 217, 0.5);
}

.stats-number-success {
    color: var(--color-success) !important;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

[data-theme="dark"] .stats-number-success {
    text-shadow: 0 0 10px rgba(45, 216, 163, 0.5);
}

.stats-number-warning {
    color: var(--color-warning) !important;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

[data-theme="dark"] .stats-number-warning {
    text-shadow: 0 0 10px rgba(242, 169, 59, 0.5);
}

.stats-number-info {
    color: #ff6b6b !important;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

[data-theme="dark"] .stats-number-info {
    text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
}

.stats-label {
    color: var(--text-secondary) !important;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Badges */
.badge {
    font-size: 0.875em;
    padding: 0.5rem 0.75rem;
}

/* Card adaptado ao tema */
.card-header h2 {
    color: var(--color-primary) !important;
}

.card-header small {
    color: var(--text-muted) !important;
}

/* Texto secundário */
small {
    color: var(--text-secondary);
}

/* Botões */
.btn i {
    vertical-align: middle;
}

.btn-info {
    background-color: var(--color-info);
    color: white !important;
    border: none;
}

.btn-info:hover {
    background-color: #2563eb;
    color: white !important;
}

/* Responsividade */
@media (max-width: 768px) {
    .table-responsive {
        margin: 0 -1rem;
    }

    .questao-numero {
        position: sticky;
        left: 0;
        z-index: 1;
        background-color: var(--bg-surface);
    }

    [data-theme="dark"] .questao-numero {
        background-color: var(--bg-main);
    }

    .btn-group {
        flex-direction: column;
        width: 100%;
    }

    .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 0.25rem;
    }

    .col-md-3 {
        margin-bottom: 1rem;
    }
}

/* Animações suaves */
.card {
    transition: transform 0.2s ease-in-out;
}

/* Melhor visualização dos alertas */
.alert {
    border-radius: 10px;
    border-width: 2px;
}

.alert-heading {
    color: inherit !important;
}

/* Texto de destaque */
strong {
    color: var(--text-primary);
}

/* Links dentro de alertas */
.alert a {
    color: inherit;
    text-decoration: underline;
}

/* Modal adaptado ao tema */
.modal-body p {
    color: var(--text-primary);
}

/* Ícones coloridos mantêm sua cor */
.text-warning {
    color: var(--color-warning) !important;
}

.text-danger {
    color: var(--color-danger) !important;
}

/* Garante que ícones nos badges mantenham visibilidade */
.badge i {
    color: inherit;
}
</style>
{% endblock %}